<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Login - Reset System</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .btn { padding: 15px 30px; margin: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .btn.danger { background: #dc3545; }
        .btn.danger:hover { background: #c82333; }
        .result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid #007bff; }
        .success { border-left-color: #28a745; background: #d4edda; }
        .error { border-left-color: #dc3545; background: #f8d7da; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 3px; overflow-x: auto; }
        .input-field { padding: 10px; margin: 5px; width: 200px; }
        .form-group { margin: 10px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
    </style>
</head>
<body>
    <h1>🔧 Login System Fix</h1>
    
    <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
        <h3>⚠️ Sistem Sıfırlama</h3>
        <p>Login çalışmıyorsa, sistemi sıfırlayın ve test edin.</p>
    </div>

    <div>
        <h3>1. Sistem Durumu</h3>
        <button class="btn" onclick="checkSystem()">Sistem Durumunu Kontrol Et</button>
        <div id="systemStatus"></div>
    </div>

    <div>
        <h3>2. Veri Sıfırlama</h3>
        <button class="btn danger" onclick="resetAll()">TÜM VERİLERİ SIFIRLA</button>
        <button class="btn" onclick="initializeMockData()">Mock Veri Yükle</button>
        <div id="resetResult"></div>
    </div>

    <div>
        <h3>3. Kullanıcıları Kontrol Et</h3>
        <button class="btn" onclick="showUsers()">Kullanıcıları Göster</button>
        <div id="usersList"></div>
    <div>
        <h3>4. Login Test</h3>
        <div class="form-group">
            <label for="username">Kullanıcı Adı:</label>
            <input type="text" id="username" value="admin" class="input-field">
        </div>
        <div class="form-group">
            <label for="password">Şifre:</label>
            <input type="password" id="password" value="admin123" class="input-field">
        </div>
        <button class="btn" onclick="testLogin()">Login Test Et</button>
        <div id="loginTestResult"></div>
    </div>
        <div id="loginTestResult"></div>
    </div>

    <div>
        <h3>5. Manuel Admin Ekle</h3>
        <button class="btn" onclick="addAdminManually()">Admin Kullanıcısını Ekle</button>
        <div id="manualAddResult"></div>
    </div>

    <script src="assets/js/database-fixed.js"></script>
    <script src="assets/js/auth.js"></script>
    <script>
        function checkSystem() {
            const status = document.getElementById('systemStatus');
            
            const currentUser = localStorage.getItem('currentUser');
            const mockUsers = localStorage.getItem('mockUsers');
            const mockActivities = localStorage.getItem('mockActivities');
            
            status.innerHTML = `
                <div class="result">
                    <strong>LocalStorage Durumu:</strong><br>
                    currentUser: ${currentUser ? '✅ Mevcut' : '❌ Yok'}<br>
                    mockUsers: ${mockUsers ? '✅ Mevcut (' + JSON.parse(mockUsers).length + ' kullanıcı)' : '❌ Yok'}<br>
                    mockActivities: ${mockActivities ? '✅ Mevcut' : '❌ Yok'}<br><br>
                    
                    <strong>Window Objects:</strong><br>
                    window.db: ${window.db ? '✅ Mevcut' : '❌ Yok'}<br>
                    window.DatabaseService: ${window.DatabaseService ? '✅ Mevcut' : '❌ Yok'}<br>
                    login function: ${typeof login === 'function' ? '✅ Mevcut' : '❌ Yok'}<br>
                    getCurrentUser function: ${typeof getCurrentUser === 'function' ? '✅ Mevcut' : '❌ Yok'}
                </div>
            `;
        }

        function resetAll() {
            localStorage.clear();
            sessionStorage.clear();
            
            document.getElementById('resetResult').innerHTML = `
                <div class="result success">
                    ✅ Tüm veriler silindi!<br>
                    Şimdi "Mock Veri Yükle" butonuna tıklayın.
                </div>
            `;
        }

        function initializeMockData() {
            if (window.db) {
                window.db.initializeMockData();
                document.getElementById('resetResult').innerHTML = `
                    <div class="result success">
                        ✅ Mock veriler yüklendi!<br>
                        "Kullanıcıları Göster" ile kontrol edin.
                    </div>
                `;
            } else {
                document.getElementById('resetResult').innerHTML = `
                    <div class="result error">
                        ❌ Database service bulunamadı!<br>
                        Sayfayı yenileyin.
                    </div>
                `;
            }
        }

        async function showUsers() {
            try {
                let users = [];
                
                if (window.db) {
                    users = await window.db.getAllUsers();
                } else {
                    const mockUsers = localStorage.getItem('mockUsers');
                    users = mockUsers ? JSON.parse(mockUsers) : [];
                }
                
                document.getElementById('usersList').innerHTML = `
                    <div class="result">
                        <strong>Toplam ${users.length} kullanıcı bulundu:</strong><br><br>
                        ${users.map(user => `
                            <div style="background: white; padding: 10px; margin: 5px; border-radius: 3px;">
                                👤 <strong>${user.username}</strong> / ${user.password}<br>
                                📧 ${user.email} | 👑 ${user.role} | ✅ ${user.status}
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                document.getElementById('usersList').innerHTML = `
                    <div class="result error">
                        ❌ Hata: ${error.message}
                    </div>
                `;
            }
        }

        async function testLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const result = document.getElementById('loginTestResult');
            
            result.innerHTML = '<div class="result">⏳ Login test ediliyor...</div>';
            
            try {
                console.log('Testing login:', username, password);
                
                if (typeof login !== 'function') {
                    throw new Error('login fonksiyonu bulunamadı!');
                }
                
                const loginResult = await login(username, password);
                console.log('Login result:', loginResult);
                
                result.innerHTML = `
                    <div class="result ${loginResult.success ? 'success' : 'error'}">
                        <strong>${loginResult.success ? '✅ Başarılı' : '❌ Başarısız'}</strong><br>
                        ${loginResult.success ? 
                            `Kullanıcı: ${loginResult.user.username}<br>Rol: ${loginResult.user.role}<br>Yönlendirilecek: ${loginResult.user.role === 'admin' ? 'admin/dashboard.html' : 'dashboard.html'}` : 
                            `Hata: ${loginResult.message || 'Bilinmeyen hata'}`
                        }
                    </div>
                `;
            } catch (error) {
                console.error('Login test error:', error);
                result.innerHTML = `
                    <div class="result error">
                        ❌ Exception: ${error.message}<br>
                        <pre>${error.stack}</pre>
                    </div>
                `;
            }
        }

        function addAdminManually() {
            const adminUser = {
                id: 1,
                username: 'admin',
                email: 'admin@example.com',
                password: 'admin123',
                first_name: 'Admin',
                last_name: 'User',
                role: 'admin',
                status: 'active',
                created_at: new Date().toISOString(),
                last_login: null,
                bio: 'Sistem yöneticisi',
                phone: '+90 555 000 0001',
                gender: null,
                profile_image: null,
                secondary_image: null,
                terms_accepted: true,
                terms_accepted_at: new Date().toISOString()
            };

            const johnUser = {
                id: 2,
                username: 'john_doe',
                email: 'john@example.com', 
                password: 'user123',
                first_name: 'John',
                last_name: 'Doe',
                role: 'user',
                status: 'active',
                created_at: new Date().toISOString(),
                last_login: null,
                bio: 'Demo kullanıcısı',
                phone: '+90 555 123 4567',
                gender: 'male',
                profile_image: 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=400&h=400&fit=crop&crop=face',
                secondary_image: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400&h=400&fit=crop&crop=face',
                terms_accepted: true,
                terms_accepted_at: new Date().toISOString()
            };

            const janeUser = {
                id: 3,
                username: 'jane_smith',
                email: 'jane@example.com',
                password: 'user123',
                first_name: 'Jane',
                last_name: 'Smith',
                role: 'user',
                status: 'active',
                created_at: new Date().toISOString(),
                last_login: null,
                bio: 'Demo kullanıcısı',
                phone: '+90 555 987 6543',
                gender: 'female',
                profile_image: 'https://images.unsplash.com/photo-1494790108755-2616b612b786?w=400&h=400&fit=crop&crop=face',
                secondary_image: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=400&h=400&fit=crop&crop=face',
                terms_accepted: true,
                terms_accepted_at: new Date().toISOString()
            };

            const users = [adminUser, johnUser, janeUser];
            localStorage.setItem('mockUsers', JSON.stringify(users));
            
            document.getElementById('manualAddResult').innerHTML = `
                <div class="result success">
                    ✅ 3 kullanıcı manuel olarak eklendi:<br>
                    • admin / admin123 (admin)<br>
                    • john_doe / user123 (user)<br>
                    • jane_smith / user123 (user)
                </div>
            `;
        }

        // Auto check on load
        window.addEventListener('DOMContentLoaded', function() {
            setTimeout(checkSystem, 500);
        });
    </script>
</body>
</html>